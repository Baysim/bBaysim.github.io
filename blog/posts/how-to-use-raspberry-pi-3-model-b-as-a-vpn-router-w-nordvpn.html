<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>How to use Raspberry Pi 3 Model B as a VPN router w/ NordVPN | Dhaval Savalia</title>
    <link href="https://fonts.googleapis.com/css?family=Inconsolata|Lora" rel="stylesheet">
    <link rel="stylesheet" href="../fonts.css">
    <link rel="stylesheet" href="../wing.css">
    <link rel="stylesheet" href="post.css">
  </head>
  <body>
    <div class="container">
      <a href="../" id="back">
        <svg width="37" height="24" viewBox="0 0 37 24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
          <title>Arrow</title>
          <path id="back-arrow" d="M36.0607 1.06066c.5857-.585786.5857-1.535534 0-2.12132l-9.546-9.54594c-.5858-.5858-1.5355-.5858-2.1213 0-.5858.5858-.5858 1.53553 0 2.12132L32.8787 0l-8.4853 8.48528c-.5858.58579-.5858 1.53552 0 2.12132.5858.5858 1.5355.5858 2.1213 0l9.546-9.54594zM0 1.5h35v-3H0v3z" transform="rotate(180 18.5 6)" fill="#888"></path>
        </svg>
      </a>

      <h1 class="post-title">How to use Raspberry Pi 3 Model B as a VPN router w/ NordVPN</h1>
      <h4 class="post-date">November 12, 2017</h4>
      <div class="post-content">
        <p>Internet security is very essential nowadays. Increasing technology knowledge made internet so vulnerable that anyone can spy your data, watch your internet activities, and what not. Government and Hackers can constantly keep watch on you. Internet censorship is something that might annoy you while travelling in another country, when you can not stream Netflix or Spotify.</p>
        <p>VPN (Virtual Private Network) comes to our rescue to deal with security breaches. Now VPN are great for security but if you want extra layer of security alongside of current VPN this article is for you!</p>
        <p>Also this article in helpful in following scenarios:</p>
        <ul>
          <li>Multi-hop VPN servers</li>
          <li>wlan0 to eth0 bridge</li>
        </ul>

        <h3>What we want to achieve in this tutorial</h3>

        <p>We are going to connect to any wifi router/hotspot (that is wlan0), secure the traffic with VPN (that is tun0), and route that encrypted traffic via Ethernet to laptop or computer (that is eth0). I think you get the idea.</p>
        <p>We can also multi-hop VPN servers, i.e. connect to server x on Raspberry Pi, route that traffic to computer via ethernet and connect to server y on computer with native VPN client of your provider. more on multi-hop here and here. Anyways NordVPN provides Double-VPN servers (2 hop chain).</p>
        <p>In another case, if you don't have router/hotspot with VPN capabilities and you want to connect to VPN on Gaming console or Streaming devices which also don't have VPN, this tutorial can surely help you out.</p>

        <h2>Let's do it!</h2>

        <h3>What you need:</h3>

        <ul>
          <li>Raspberry Pi 3 Model B with Raspbian OS installed</li>
          <li>Ethernet cable</li>
          <li>A VPN subscription, I'd prefer NordVPN. Buy it from my <a href="http://bit.ly/2zx2Ne2">link</a>, it will help me bring you more content like this!</li>
          <li>and that is pretty much it...</li>
        </ul>

        <h3>Step 1:</h3>
        <p>Set up Raspberry Pi with Raspbian OS and update it,</p>

        <pre>
          <code>sudo apt-get update && sudo apt-get upgrade -y && sudo install rpi-update</code>
        </pre>

        <h3>Step 2:</h3>
        <p>In this step we will connect to a wifi network and create internal DHCP server in Raspberry Pi's Ethernet to further share traffic via eth0. IP will be assigned by Pi's Ethernet, not by wifi, but it will get the job done.</p>
        <p>Connect to a wifi network:</p>
        <p>To setup wifi from cli you need to add that network in wpa_supplicant.conf</p>
        <pre>
          <code>sudo nano /etc/wpa_supplicant/wpa_supplicant.conf</code>
        </pre>
        <p>and add your network,</p>

        <pre>
          <code>network={
             ssid="mynetwork"
             psk="secret"
             key_mgmt=WPA-PSK
        }</code>
        </pre>

        <h3>Ethernet static IP:</h3>
        <p>Now we need to assign a static ip for DHCP server,</p>

        <pre><code>sudo nano /etc/network/interfaces</code></pre>

        <p>Next, add this code,</p>
        <pre>
<code>allow-hotplug wlan0
auto wlan0
iface wlan0 inet dhcp
    wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf

allow-hotplug eth0
iface eth0 inet static
    address 172.24.1.1
    netmask 255.255.255.0
    network 172.24.1.0
    broadcast 172.24.1.255</code>
        </pre>

        <h3>Step 3:</h3>
        <p>In this step we will setup dnsmasq,</p>

        <p>Install dnsmasq,</p>

        <pre><code>sudo apt-get install dnsmasq</code></pre>

        <p>Now, backup old dnsmasq conf and create new one:</p>

        <pre><code>sudo mv /etc/dnsmasq.conf /etc/dnsmasq.conf.orig
sudo nano /etc/dnsmasq.conf</code></pre>

<p>Add:</p>

<pre><code>interface=eth0 # Use interface eth0
listen-address=172.24.1.1 # Explicitly specify the address to listen on
bind-interfaces # Bind to the interface to make sure we aren't sending things elsewhere
server=162.242.211.137,78.46.223.24 # Forward DNS requests to NordVPN DNS
domain-needed # Don't forward short names
bogus-priv # Never forward addresses in the non-routed address spaces.
dhcp-range=172.24.1.50,172.24.1.150,12h # Assign IP addresses between 172.24.1.50 and 172.24.1.150 with a 12 hourlease time</code></pre>

<h3>Step 3:</h3>
<p>In this step we will enable IPv4 Forwarding.</p>

<pre><code>sudo nano /etc/sysctl.conf</code></pre>

<p>Uncomment the following line,</p>

<pre><code>net.ipv4.ip_forward=1</code></pre>

<p>Next, we will route tun0 traffic,</p>

<pre><code>sudo iptables -t nat -A POSTROUTING -o tun0 -j MASQUERADE</code></pre>

<p>Okay, we are almost done with configuring our network. But we need to make these changes persistent, so it automatically load on every boot. To make changes persistent we need to install iptables-persistent,</p>

<pre><code>sudo apt-get install iptables-persistent</code></pre>

<p>The installer will ask if you want to save current rules, select Yes.</p>
<p>If you don't select yes, you can always save it later with</p>

<pre><code>sudo netfilter-persistent save</code></pre>

<h3>Step 4:</h3>
<p>It is a fun part now. We will set up VPN!</p>
<p>I suggest you to go for <a href="http://bit.ly/2zx2Ne2">NordVPN</a>, I know I am bragging a lot about it, but its just awesome. It one of the few VPN provider which is not yet blocked by Netflix and other services.</p>
<p>Here is a deal, $99 for 3 years!!!</p>
<p>Best buy link - <a href="http://bit.ly/2zx2Ne2">https://ref.nordvpn.com/?id=35986039f</a></p>

<p>Anyways, let's setup VPN, I am using NordVPN but you can use literally any VPN as long as it supports OpenVPN configs.</p>

<p>Install the OpenVPN client:</p>

<pre><code>sudo apt-get install openvpn</code></pre>

<p>Download OpenVPN config to openvpn directory itself,</p>

<pre><code>cd /etc/openvpn/ && sudo wget https://nordvpn.com/api/files/zip</code></pre>

<p>**In case you will get `ERROR: The certificate of `nordvpn.comâ€™ is not trusted.`, please install `ca-certificates` package with command:</p>

<pre><code>apt-get install ca-certificates</code></pre>

<p>Extract ovpn.zip with 'unzip',</p>

<pre><code>sudo unzip zip</code></pre>

<p>Now you have list of latest servers (use this command to list all servers, "ls -al" ), you need to configure these .ovpn files in order to use it as soon as your Pi boots. We have to rename .ovpn to .conf, while copying, here is the example,</p>

<pre><code>sudo cp us493.nordvpn.com.tcp443.ovpn /etc/openvpn/us493.conf</code></pre>

<p>Now create /etc/openvpn/login by,</p>

<pre><code>sudo touch /etc/openvpn/login && sudo nano /etc/openvpn/login</code></pre>

<p>Type you account credentials into login files,</p>

<pre><code>user123456
passwordhere</code></pre>

<p>Change permissions so only root can see login file,</p>

<pre><code>sudo chmod 600 /etc/openvpn/login</code></pre>

<p>It is time to configure previously copied .conf file to auto-login</p>

<pre><code>sudo nano /etc/openvpn/us493.conf</code></pre>

<p>Find this test "auth-user-pass" and change it to "auth-user-pass /etc/openvpn/login",</p>
<p>Let's test our VPN,</p>

<pre><code>sudo openvpn --config /etc/openvpn/us493.conf</code></pre>

<p>Now exit out with Ctrl + c</p>

<p>Enable OpenVPN at boot,</p>

<pre><code>sudo systemctl enable openvpn@us493</code></pre>

<h3>Step 5:</h3>
<p>Save all rules and config,</p>

<pre><code>sudo netfilter-persistent save</code></pre>

<p>You are good to go now!</p>
<p>Reboot with,</p>

<pre><code>sudo reboot</code></pre>

<p>Now, your Raspberry Pi will automatically connect to wifi automatically and connect to VPN at boot. Just plug your ethernet to Pi and computer it will work as charm. And NordVPN says, Take back control over your Internet browsing.</p>

<p>Good luck!</p>
      </div>
    </div>
  </body>
</html>
